<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>My Bookings - LakeSide Hotel</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-5">
            <h2 class="text-center mb-4">
                <i class="fas fa-list"></i> 
                <span th:if="${isAuthenticated}">My Bookings</span>
                <span th:unless="${isAuthenticated}">Recent Bookings</span>
            </h2>
            
            <!-- Authentication status message -->
            <div th:unless="${isAuthenticated}" class="alert alert-info text-center mb-4">
                <p><i class="fas fa-info-circle"></i> <strong>Note:</strong> You're viewing recent bookings as a guest. 
                   To see only your bookings, please <a href="/login" class="alert-link">login</a> to your account.</p>
            </div>
            
            <!-- No Bookings Message -->
            <div th:if="${bookings == null or bookings.isEmpty()}" class="text-center py-5">
                <div class="alert alert-info">
                    <h4>No Bookings Found</h4>
                    <p th:if="${isAuthenticated}">You haven't made any bookings yet.</p>
                    <p th:unless="${isAuthenticated}">No recent bookings to display.</p>
                    <a href="/rooms" class="btn btn-primary mt-3">
                        <i class="fas fa-search"></i> Browse Rooms
                    </a>
                </div>
            </div>
            
            <!-- Bookings Table -->
            <div th:if="${bookings != null and !bookings.isEmpty()}" class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Confirmation Code</th>
                            <th>Room ID</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Guest Name</th>
                            <th>Adults</th>
                            <th>Children</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="booking : ${bookings}">
                            <td>
                                <code th:text="${booking.bookingConfirmationCode}">ABC123</code>
                            </td>
                            <td th:text="${booking.room?.id}">101</td>
                            <td th:text="${#temporals.format(booking.checkInDate, 'MMM dd, yyyy')}">Jan 01, 2024</td>
                            <td th:text="${#temporals.format(booking.checkOutDate, 'MMM dd, yyyy')}">Jan 05, 2024</td>
                            <td th:text="${booking.guestFullName}">John Doe</td>
                            <td th:text="${booking.numOfAdults}">2</td>
                            <td th:text="${booking.numOfChildren}">0</td>
                            <td>
                                <span class="badge bg-success" 
                                      th:if="${#temporals.createToday().isBefore(booking.checkInDate)}">
                                    Upcoming
                                </span>
                                <span class="badge bg-primary" 
                                      th:if="${!#temporals.createToday().isBefore(booking.checkInDate) and !#temporals.createToday().isAfter(booking.checkOutDate)}">
                                    Active
                                </span>
                                <span class="badge bg-secondary" 
                                      th:if="${#temporals.createToday().isAfter(booking.checkOutDate)}">
                                    Completed
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info view-booking-btn" 
                                        th:data-booking-code="${booking.bookingConfirmationCode}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-danger cancel-booking-btn" 
                                        th:if="${#temporals.createToday().isBefore(booking.checkInDate)}"
                                        th:data-booking-code="${booking.bookingConfirmationCode}">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Action Buttons -->
            <div class="text-center mt-4">
                <a href="/rooms" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Make New Booking
                </a>
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-home"></i> Back to Home
                </a>
            </div>
        </div>
        
        <!-- Booking Details Modal -->
        <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Booking Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="bookingDetailsContent">
                        <!-- Content will be loaded dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            // Add event listeners when the DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                // View booking buttons
                document.querySelectorAll('.view-booking-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const confirmationCode = this.getAttribute('data-booking-code');
                        viewBookingDetails(confirmationCode);
                    });
                });
                
                // Cancel booking buttons
                document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const confirmationCode = this.getAttribute('data-booking-code');
                        cancelBooking(confirmationCode);
                    });
                });
            });

            function viewBookingDetails(confirmationCode) {
                // Fetch booking details and show in modal
                fetch('/bookings/confirmation/' + confirmationCode)
                    .then(response => response.json())
                    .then(booking => {
                        const content = `
                            <div class="booking-details">
                                <p><strong>Confirmation Code:</strong> ${booking.bookingConfirmationCode}</p>
                                <p><strong>Guest Name:</strong> ${booking.guestFullName}</p>
                                <p><strong>Email:</strong> ${booking.guestEmail}</p>
                                <p><strong>Room ID:</strong> ${booking.room?.id || 'N/A'}</p>
                                <p><strong>Room Type:</strong> ${booking.room?.roomType || 'N/A'}</p>
                                <p><strong>Check-In:</strong> ${new Date(booking.checkInDate).toLocaleDateString()}</p>
                                <p><strong>Check-Out:</strong> ${new Date(booking.checkOutDate).toLocaleDateString()}</p>
                                <p><strong>Adults:</strong> ${booking.numOfAdults}</p>
                                <p><strong>Children:</strong> ${booking.numOfChildren}</p>
                                <p><strong>Total Guests:</strong> ${booking.numOfAdults + booking.numOfChildren}</p>
                            </div>
                        `;
                        document.getElementById('bookingDetailsContent').innerHTML = content;
                        new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
                    })
                    .catch(error => {
                        alert('Error loading booking details: ' + error.message);
                    });
            }
            
            function cancelBooking(confirmationCode) {
                if (confirm('Are you sure you want to cancel this booking?')) {
                    fetch('/bookings/confirmation/' + confirmationCode, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Booking cancelled successfully');
                            window.location.reload();
                        } else {
                            return response.text().then(text => {
                                throw new Error(text || 'Failed to cancel booking');
                            });
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
                }
            }
        </script>
    </th:block>
</body>
</html>
